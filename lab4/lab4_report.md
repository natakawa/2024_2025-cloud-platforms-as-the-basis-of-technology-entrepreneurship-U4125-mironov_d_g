# Лабораторная работа №3 «Исследование Cloud Storage»

**University:** [ITMO University](https://itmo.ru/ru/)  
**Faculty:** [FTMI](https://ftmi.itmo.ru)  
**Course:** [Cloud platforms as the basis of technology entrepreneurship](https://itmo-ict-faculty.github.io/cloud-platforms-as-the-basis-of-technology-entrepreneurship/)  
**Year:** 2024/2025  
**Group:** U4125  
**Author:** Mironov Daniil Gennadevich  
**Lab:** Lab4  
**Date of create:** 02.05.2025  
**Date of finished:** 


## Что за приложение?

AI‑трекер калорий — мобильное приложение для iOS и Android, позволяющее пользователю фотографировать блюда и получать расчёт калорийности, белков, жиров и углеводов. В основе анализа лежит MLLM модель **Gemini 2.0 Flash** (Vertex AI): она эффективно обрабатывает изображения и текстовые корректировки, обеспечивая высокую точность вывода при сравнительно низкой задержке и стоимости интерференса.

**Почему Gemini 2.0 Flash?**

* Мультимодальная поддержка: обрабатывает изображения и текст в едином контексте.
* Экономическая эффективность: \$0.15 за 1 M входных токенов и \$0.60 за 1 M выходных токенов, что выгоднее самостоятельного хостинга MLLM на GPU.

## 1. Технический стек

| Слой            | Технология                    | Обоснование                                                                              |
| --------------- | ----------------------------- | ---------------------------------------------------------------------------------------- |
| Клиент          | Flutter 3.22                  | Единая код‑база для iOS/Android, нативная производительность                             |
| Авторизация     | Firebase Authentication       | Поддержка e‑mail/Apple/Google, бесплатный до 10 000 MAU                                  |
| API‑шлюз        | Cloud Endpoints       | Rate‑limiting, JWT‑валидация                                                             |
| Бизнес‑логика   | Cloud Run                     | Серверless, бесплатный уровень до 2 M запросов/180 000 vCPU‑s в месяц |
| AI     | Gemini 2.0 Flash через провайдера Vertex AI| Оптимальное соотношение скорости, стоимости и качества результата                        |
| Хранение данных | Cloud Firestore | Realtime SDK, строгие правила безопасности, простая схема документов                     |
| Медиа‑файлы     | Cloud Storage Standard   | \$0.020 / GB‑мес, бесплатный трафик внутри GCP                                           |
| CDN             | Cloud CDN                     | Быстрая доставка медиа по Европе                                     |

## 2. Архитектура инфраструктуры

![Диаграмма](../screenshots/diagram.png)

## 3. Расчёты затрат

Предполагаем в среднем **5 запросов/сутки** на пользователя, каждый запрос — 1 фото (\~1 290 токенов) + 400 токенов prompt; выход — \~600 токенов JSON.

### Формулы расчёта

1. **Запросы в день**
   `R = DAU × 5`

2. **Токены за месяц (30 дней)**
   `T_in  = R × 1690 × 30`
   `T_out = R ×  600 × 30`

3. **Стоимость Gemini**
   `C_in  = T_in /1 000 000 × 0.15`
   `C_out = T_out/1 000 000 × 0.60`
   `C_G   = C_in + C_out`

4. **Firestore**
   *Writes:* `W_day = R`; бесплатные 20 k → платные `W_pay = max(0, W_day−20 000) × 30`
   `C_FW = W_pay /100 000 × 0.099`
   *Storage:* `Docs = R × 30`, средний размер 0.5 KB →
   `GB = Docs × 0.5 /1024 /1024`, `C_FS = GB × 0.165`
   `C_Firestore = C_FW + C_FS`

5. **Cloud Run (CPU only‑during‑request)**
   `CPU_sec = R × 0.2 s × 30`, бесплатные 240 k → платные `CPU_pay`
   `C_CR = CPU_pay × 0.000018`; RAM не выходит за free‑tier.

6. **Cloud Storage**
   `Images = R × 30`, объём `GB = Images × 1 MB /1024`
   `C_Storage = GB × 0.020`

### Таблица затрат (мес)

| Stage |    DAU | Запросы/сут | In‑токены, M | Out‑токены, M | **Gemini \$** | Firestore \$ | Cloud Run \$ | Storage \$ | **Итого \$** |
| ----- | -----: | ----------: | -----------: | ------------: | ------------: | -----------: | -----------: | ---------: | -----------: |
| Dev   |    100 |         500 |    **25.35** |       **9.0** |      **9.20** |        0.001 |            0 |       0.29 |     **9.50** |
| Pilot |  1 000 |       5 000 |    **253.5** |      **90.0** |     **92.03** |        0.012 |            0 |       2.93 |    **94.97** |
| Prod  | 10 000 |      50 000 |    **2 535** |     **900.0** |    **920.25** |         1.01 |         1.08 |      29.30 |   **951.64** |


## Стоимость и лимиты сервисов

Цена Gemini 2.0 Flash (на основе токенов)
- **Вход**: $0.15 за 1 миллион токенов  
- **Выход**: $0.60 за 1 миллион токенов *(режим "no thinking")*

Токены на 1 запрос
- **Вход**:
  - Изображение 1024² px: 1 290 токенов
  - Prompt: 400 токенов  
  - **Итого**: 1 690 токенов
- **Выход**: 600 токенов

Cloud Run
- **Бесплатный лимит**:
  - 240 000 vCPU-секунд
  - 450 000 GiB-секунд
- **Сверх лимита**:
  - CPU: $0.000018 / vCPU-сек
  - RAM: $0.000002 / GiB-сек

Firestore (регион: Финляндия `europe-north1`)
- **Бесплатно в день**:
  - 20 000 записей (writes)
  - 50 000 чтений (reads)
- **Сверх лимита**:
  - Запись: $0.099 за 100 000 операций
  - Чтение: $0.033 за 100 000 операций
  - Хранение: $0.165 / GiB в месяц

Cloud Storage Standard (Финляндия)
- $0.020 / GB в месяц
